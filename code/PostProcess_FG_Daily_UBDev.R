#############
#Generic Script to make Multitrace Plot and Exceedance Plot for Flow from rdf
#############

#NOT IN CRSS FOLDER, somewhere for her to put with CRSSDIR reference 

library('tidyverse')
library('RWDataPlyr')
library('scales') #need this for scale_x_date()
source('code/Stat_emp_ExcCrv.r')

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#    -------------------        USER INPUT        ----------------------
# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

#Set folder where studies are kept as sub folders. 
CRSSDIR <- Sys.getenv("CRSS_DIR")
#default structure from RiverSmart study
iFolder <- file.path(CRSSDIR,"Scenario") 
#OR if somewhere else
# iFolder <- "CompleteFilePath" #replace this with path to folder with senarios 

list.dirs(iFolder) #list dirs in set folder folder for us in next input

#scenarios you want to compare 
scens <- list(
  "Aug 2018" = "Aug2018_2019,DNF,2007Dems,IG,Most",
  "Aug 2018 + Fix" = "Aug2018_2019_9000,DNF,2007Dems,IG_9000,Most_BM_FGltsp"
)

list.files(file.path(iFolder,scens[1])) #list files in scen folder for next input

#rdf file with slot you want 
file = "DailyFlows.rdf" 

rdf_slot_names(read_rdf(iFile = file.path(iFolder,scens[1],file))) #check slots in rdf

variables = c("DailyFlows.FlamingGorgeDaily","DailyFlows.JensenDaily")
# objectslot = "DailyFlows.FlamingGorgeDaily"
# objectslot ="DailyFlows.JensenDaily"                 
# objectslot ="DailyFlows.YampaDailyNatural"          
# objectslot ="DailyFlows.YampaDailyDeerlodgeDepleted"

#plot inputs 
y_lab = "Daily Flow (cfs)"
filteryrlessorequal = 2019 #filter out all years > this year
# plotfoldertitle = "FG Dev" #folder to create for output in results dir 
####I'm using a custom location for output for now 
plotitle = "FG_Daily_Plots_LTSP" #objectslot + .pdf will be added when creating plots 


# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#    ----        CODE: FG - MODIFY AT YOUR OWN RISK        ----------------------
# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

# oFigs <- file.path(CRSSDIR,'results', plotfoldertitle) 
# if (!file.exists(oFigs)) {
#   message(paste('Creating folder:', oFigs))
#   dir.create(oFigs)
# }

ofigs <- "C:/Users/cfelletter/Documents/CRSS working/2018UBRedesign"
if (!file.exists(ofigs)) {
  message(paste('Creating folder:', ofigs))
  dir.create(ofigs)
}

message('Figures and tables will be saved to: ', oFigs)

j=i=1
# for (j in 1:length(variables)) {
pdf(file.path(oFigs,paste0(plotitle,".pdf")), width=9, height=6)

objectslot = variables[j]
title = objectslot
print(objectslot)

for (i in 1:length(scens)) {
  #try getting daily another way
  scen_res_x <- file.path(iFolder,scens[i],file) %>% #this means "pipe" the data to the next function 
    rdf_to_rwtbl2() %>%
    filter(ObjectSlot == objectslot)
  
  # #filter out Most,Min,Max only would do this for MTOM 
  # filter(TraceNumber >= first_ensemble[1]) 
  
  #add on Scenario since rdf_to_rwtbl2 doesn't add it  
  scen_res_x <- cbind.data.frame(
    scen_res_x,
    Scenario = rep(names(scens)[i], Times = length(scen_res_x$Timestep))
  )
  
  #convert Timestep chr to POSIXct
  scen_res_x$Timestep <- as.POSIXct(strptime(scen_res_x$Timestep,"%Y-%m-%d %H:%M")) 
  scen_res_x$Timestep <- as.Date(scen_res_x$Timestep)
  #first entry is 2019-1-31 24:00 which gets converted to 2019-02-01, is that okay????? 
  
  if(i == 1){
    scen_res = scen_res_x
  } else {
    scen_res = rbind.data.frame(scen_res,scen_res_x)
  }
} #close i Scenario loop 

unique(scen_res$ObjectSlot) #check variable names 
unique(scen_res$Scenario) #check Scenario names 


scen_res$MonthNum = as.Date(paste0(scen_res$Year,scen_res$Month,"01"), format = "%Y%B%d")
#get a numeric month number
scen_res$MonthNum = as.numeric(format.Date(scen_res$Timestep, format = "%m"))
scen_res$DayNum = as.numeric(format.Date(scen_res$Timestep, format = "%d"))


# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#    ----        PLOTS: FG - MODIFY AT YOUR OWN RISK        ----------------------
# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

## plot 
pdf(file.path(ofigs,paste0(plotitle,objectslot,".pdf")), width=9, height=6)

#    -------------------        All Trace Mean        ----------------------


#CF, 20180905: added commas and changed title 
scen_res %>%
  dplyr::filter(Year <= filteryrlessorequal) %>% #one run has 2023 so filter that out so axis work
  dplyr::group_by(Scenario, Timestep) %>% #don't need to do this since only one var
  # dplyr::group_by(Scenario, DayNum) %>% #don't need to do this since only one var
  # dplyr::group_by(Scenario, MonthNum) %>% #don't need to do this since only one var
  dplyr::summarise(Value = mean(Value)) %>%
  # ggplot(aes(DayNum, Value, color = Scenario)) + 
  ggplot(aes(Timestep, Value, color = Scenario)) + 
  # ggplot(aes(MonthNum, Value, color = Scenario)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(labels = scales::comma) + #add commas to axis 
  labs(title = paste("Mean","Flaming Gorge Daily Flow CY",filteryrlessorequal), y = y_lab) +
  # scale_x_discrete("Month",labels = month.abb) #+ #display abb. month names
  
  scale_x_date("Month", breaks = date_breaks("months"),
             labels = date_format("%b"))

#### NOTE: The months appear to start in Feb since first CRSS timestep is Jan31! 
message("The months appear to start in Feb since first CRSS timestep is Jan31!")

#    -------------------        All Trace Boxplot        ----------------------

scen_res %>%
  dplyr::filter(Year <= filteryrlessorequal) %>% #one run has 2023 so filter that out so axis work
  dplyr::group_by(Scenario, Timestep) %>% #don't need to do this since only one var
  dplyr::group_by(Scenario, MonthNum) %>% #don't need to do this since only one var
  ggplot(aes(x = factor(MonthNum), y = Value, color = Scenario)) +
  geom_boxplot() +
  # stat_boxplot_custom() +
  scale_x_discrete("Month",labels = month.abb) + #display abb. month names
  labs(title = paste(title,filteryrlessorequal), y = y_lab) 

#    -------------------        Percent Exceedance of Traces       ----------------------

scen_res %>%
  dplyr::filter(Year <= filteryrlessorequal) %>% #one run has 2023 so filter that out so axis work
  dplyr::group_by(Scenario, Timestep) %>% #don't need to do this since only one var
  ggplot(aes(Value, color = Scenario)) + 
  stat_eexccrv() + 
  labs(title = paste(filteryrlessorequal,title,"Trace Exceedance"), y = y_lab, x = "Exceedance") +
  scale_x_continuous(labels = percent)


# # +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# #    ----        CODE: JENSEN - MODIFY AT YOUR OWN RISK        ----------------------
# # +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# 
# j=2
# # for (j in 1:length(variables)) {
# 
# objectslot = variables[j]
# title = objectslot
# print(objectslot)
# 
# 
# for (i in 1:length(scens)) {
#   #try getting daily another way
#   scen_res_x <- file.path(iFolder,scens[i],file) %>% #this means "pipe" the data to the next function 
#     rdf_to_rwtbl2() %>%
#     filter(ObjectSlot == objectslot)
#   
#   # #filter out Most,Min,Max only would do this for MTOM 
#   # filter(TraceNumber >= first_ensemble[1]) 
#   
#   #add on Scenario since rdf_to_rwtbl2 doesn't add it  
#   scen_res_x <- cbind.data.frame(
#     scen_res_x,
#     Scenario = rep(names(scens)[i], Times = length(scen_res_x$Timestep))
#   )
#   
#   #convert Timestep chr to POSIXct
#   scen_res_x$Timestep <- as.POSIXct(strptime(scen_res_x$Timestep,"%Y-%m-%d %H:%M")) 
#   scen_res_x$Timestep <- as.Date(scen_res_x$Timestep)
#   #first entry is 2019-1-31 24:00 which gets converted to 2019-02-01, is that okay????? 
#   
#   if(i == 1){
#     scen_res = scen_res_x
#   } else {
#     scen_res = rbind.data.frame(scen_res,scen_res_x)
#   }
# } #close i Scenario loop 
# 
# unique(scen_res$ObjectSlot) #check variable names 
# unique(scen_res$Scenario) #check Scenario names 
# 
# 
# scen_res$MonthNum = as.Date(paste0(scen_res$Year,scen_res$Month,"01"), format = "%Y%B%d")
# #get a numeric month number
# scen_res$MonthNum = as.numeric(format.Date(scen_res$Timestep, format = "%m"))
# 
# # +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# #    ----        PLOTS: Jensen - MODIFY AT YOUR OWN RISK        ----------------------
# # +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# 
# ## plot 
# # pdf(file.path(oFigs,paste0(plotitle,objectslot,".pdf")), width=9, height=6)
# 
# target1 <- data.frame(yintercept=8300) 
# target2 <- data.frame(yintercept=18600) 
# target3 <- data.frame(yintercept=22700) 
# 
# #    -------------------        All Trace Mean        ----------------------
# 
# scen_res %>%
#   # dplyr::filter(ObjectSlot == objectslot) %>% #don't need to do this since only one var
#   dplyr::filter(Year <= filteryrlessorequal) %>% #one run has 2023 so filter that out so axis work
#   dplyr::group_by(Scenario, Timestep) %>% #don't need to do this since only one var
#   dplyr::summarise(Value = mean(Value)) %>%
#   #dplyr::mutate(Value = Value/1000) %>% # converts to kaf 
#   ggplot(aes(Timestep, Value, color = Scenario)) + 
#   geom_point() +
#   geom_line() +
#   geom_hline(aes(yintercept=yintercept), data=target1) +
#   geom_hline(aes(yintercept=yintercept), data=target2) +
#   geom_hline(aes(yintercept=yintercept), data=target3) +
#   labs(title = paste("Mean",title,filteryrlessorequal), y = y_lab) +
#   scale_x_date(breaks = date_breaks("months"),
#                labels = date_format("%b"))
# 
# #    -------------------        All Trace Boxplot        ----------------------
# 
# scen_res %>%
#   dplyr::filter(Year <= filteryrlessorequal) %>% #one run has 2023 so filter that out so axis work
#   dplyr::group_by(Scenario, Timestep) %>% #don't need to do this since only one var
#   dplyr::group_by(Scenario, MonthNum) %>% #don't need to do this since only one var
#   ggplot(aes(x = factor(MonthNum), y = Value, color = Scenario)) +
#   geom_boxplot() +
#   # stat_boxplot_custom() +
#   geom_hline(aes(yintercept=yintercept), data=target1) +
#   geom_hline(aes(yintercept=yintercept), data=target2) +
#   geom_hline(aes(yintercept=yintercept), data=target3) +
#   scale_x_discrete("Month",labels = month.abb) + #display abb. month names
#   labs(title = paste(title,filteryrlessorequal), y = y_lab) 
# 
# #    -------------------        Percent Exceedance of Traces       ----------------------
# 
# scen_res %>%
#   dplyr::filter(Year <= filteryrlessorequal) %>% #one run has 2023 so filter that out so axis work
#   dplyr::group_by(Scenario, Timestep) %>% #don't need to do this since only one var
#   ggplot(aes(Value, color = Scenario)) + 
#   stat_eexccrv() + 
#   geom_hline(aes(yintercept=yintercept), data=target1) +
#   geom_hline(aes(yintercept=yintercept), data=target2) +
#   geom_hline(aes(yintercept=yintercept), data=target3) +
#   labs(title = paste(filteryrlessorequal,title,"Trace Exceedance"), y = y_lab, x = "Exceedance") +
#   scale_x_continuous(labels = percent)


dev.off()

# } #close j variable loop 


